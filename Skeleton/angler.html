<div id="wp-custom-wrapper">
    <div class="angler-dashboard">
        <header class="tracker-header">
            <div class="header-top">
                <h1>The Angler: Trophy Tracker</h1>
                <button id="sync-btn" onclick="syncWithPSN()" class="sync-button">ðŸ”„ Sync PSN Status</button>
            </div>
            <p id="stats-summary">Loading User Data...</p>
            
            <div id="psn-card-slot" class="psn-card-container">
                </div>
        </header>

        <div class="section-title">In-Progress Trophies (Imperial)</div>
        <div id="trophy-list-active"></div>

        <div class="section-title game-stats-title">Extra Exploration Stats</div>
        <div id="game-stats-container">
            <div class="mission-card-simple">
                <div class="mission-row">
                    <span class="mission-text">Current Credits (Bank)</span>
                    <span id="stat-credits" class="count-display" style="color: #f1c40f;">0</span>
                </div>
                <div class="mission-row">
                    <span class="mission-text">Fish Tally (GR)</span>
                    <span id="stat-fish" class="count-display">0 Gold | 0 Diamond | 0 Legend</span>
                </div>
                <div class="mission-row">
                    <span class="mission-text">Land-Based Vehicles (Jeep)</span>
                    <span id="stat-jeep" class="count-display">0.00 mi</span>
                </div>
                <div class="mission-row">
                    <span class="mission-text">Water-Based Vehicles (Boat)</span>
                    <span id="stat-boat" class="count-display">0.00 mi</span>
                </div>
                <div class="mission-row">
                    <span class="mission-text">Fast Travel Distance</span>
                    <span id="stat-fast-travel" class="count-display">0.00 mi</span>
                </div>
                <div class="mission-row">
                    <span class="mission-text">Reports Found (incl. Bigfoot)</span>
                    <span id="stat-reports" class="count-display" style="color: #2ecc71;">0 Found</span>
                </div>
            </div>
        </div>

        <div class="section-title completed-title">Recently Completed</div>
        <div id="trophy-list-done"></div>

        <footer class="tracker-footer">
            <p>Gear up for the season: <a href="https://www.amazon.com/s?k=fishing&tag=psngaming-20" target="_blank">Fishing Equipment</a></p>
        </footer>
    </div>

    <style>
        #wp-custom-wrapper {
            background: transparent !important;
            padding: 20px;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            color: #ffffff;
            display: flex;
            justify-content: center;
        }

        .angler-dashboard {
            width: 100%;
            max-width: 900px;
            background: rgba(10, 15, 20, 0.95);
            border: 2px solid #00d4ff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .tracker-header {
            text-align: center;
            border-bottom: 2px solid #00d4ff;
            margin-bottom: 20px;
            padding-bottom: 20px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tracker-header h1 { margin: 0; color: #00d4ff; text-transform: uppercase; letter-spacing: 2px; }
        
        .sync-button {
            background: #1a2a3a;
            color: #00d4ff;
            border: 1px solid #00d4ff;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: 20px;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        .sync-button:hover { background: #00d4ff; color: #111; }
        .syncing { opacity: 0.5; cursor: wait; }

        .psn-card-container {
            margin-top: 10px;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .psn-card-container:hover { transform: scale(1.02); }
        .psn-card-img { max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        .section-title {
            background: rgba(0, 212, 255, 0.1);
            padding: 8px 15px;
            margin: 20px 0 10px;
            border-left: 4px solid #00d4ff;
            font-weight: bold;
            text-transform: uppercase;
        }

        .completed-title { border-left-color: #2ecc71; color: #2ecc71; }
        .game-stats-title { border-left-color: #f39c12; color: #f39c12; background: rgba(243, 156, 18, 0.1); }

        .trophy-card, .mission-card-simple {
            background: rgba(30, 40, 50, 0.6);
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .mission-card-simple { padding: 10px 20px; }

        .trophy-summary {
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trophy-card.done { border-color: #2ecc71; opacity: 0.8; }

        .trophy-info { display: flex; align-items: center; gap: 12px; }
        .trophy-rank { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .rank-platinum { background: #e5e4e2; color: #333; }
        .rank-gold { background: #ffd700; color: #333; }
        .rank-silver { background: #c0c0c0; color: #333; }
        .rank-bronze { background: #cd7f32; color: #333; }

        .mission-details { display: none; padding: 10px 20px; background: rgba(0,0,0,0.3); border-top: 1px solid #2a3a4a; }
        .mission-details.active { display: block; }

        .mission-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .mission-row:last-child { border-bottom: none; }

        .mission-controls { display: flex; align-items: center; gap: 10px; }
        .btn-ctrl { background: #1a2a3a; color: #00d4ff; border: 1px solid #00d4ff; width: 26px; height: 26px; cursor: pointer; border-radius: 4px; }
        .count-display { font-family: monospace; min-width: 50px; text-align: center; color: #00d4ff; }
        
        .status-indicator { font-weight: bold; width: 20px; text-align: center; }
        .status-working { color: #f39c12; }
        .status-complete { color: #2ecc71; }

        .tracker-footer { margin-top: 30px; text-align: center; font-size: 0.8rem; color: #678; }
        .tracker-footer a { color: #00d4ff; text-decoration: none; }
    </style>

    <script>
        /** CONFIGURATION: Auto-detect User from Folder/URL **/
        const pathArray = window.location.pathname.split('/');
        // Grabs the last folder name as the PSN handle, defaults to Werewolf3788
        const currentUser = pathArray[pathArray.length - 2] || "Werewolf3788"; 

        const trophyList = [
            { id: "platinum", name: "Any Fin Is Possible", rank: "platinum", isDone: false, missions: [{ id: "m_plat", label: "Trophies Completed", target: 50, current: 0 }] },
            
            { id: "travel", name: "Have Fish, Will Travel", rank: "gold", isDone: false, missions: [
                { id: "pois", label: "Points of Interest (GR)", target: 97, current: 0 },
                { id: "towers", label: "Lookout Towers (GR)", target: 22, current: 0 },
                { id: "cabins", label: "Cabins Found (GR)", target: 19, current: 0 },
                { id: "trailheads", label: "Trailheads Found (GR)", target: 47, current: 0 },
                { id: "waterbodies", label: "Waterbodies Found (GR)", target: 26, current: 0 }
            ]},
            { id: "flounder", name: "Lost and Flounder", rank: "silver", isDone: false, missions: [
                { id: "collect_gr", label: "Total Collectibles (GR)", target: 74, current: 0 },
                { id: "notes_gr", label: "Notes Found", target: 20, current: 0 },
                { id: "coins_gr", label: "Coins Found", target: 15, current: 0 },
                { id: "dino_bones", label: "Dinosaur Bones", target: 8, current: 0 },
                { id: "bf_tracks", label: "Bigfoot Tracks", target: 8, current: 0 },
                { id: "weather_st", label: "Weather Stations", target: 8, current: 0 },
                { id: "gps_st", label: "GPS Stations", target: 8, current: 0 },
                { id: "oxeye", label: "Oxeye Daisy", target: 8, current: 0 },
                { id: "water_hy", label: "Water Hyacinth", target: 8, current: 0 },
                { id: "orange_hk", label: "Orange Hawkweed", target: 8, current: 0 },
                { id: "yellow_tf", label: "Yellow Toadflax", target: 8, current: 0 },
                { id: "engel_sp", label: "Engelmann Spruce", target: 8, current: 0 },
                { id: "douglas_fr", label: "Douglas-fir", target: 8, current: 0 },
                { id: "white_pine", label: "White Pine", target: 8, current: 0 },
                { id: "petrified", label: "Petrified Tree", target: 8, current: 0 }
            ]},
            { id: "marathon", name: "Marathon", rank: "silver", isDone: false, missions: [{ id: "miles_foot", label: "Distance on Foot (mi)", target: 62.1, current: 0 }] }, 
            { id: "boat_dist", name: "Lake Me up Before You Go Go", rank: "silver", isDone: false, missions: [{ id: "miles_boat", label: "Distance by Boat (mi)", target: 62.1, current: 0 }] },
            { id: "credits", name: "No Fin Left to Give", rank: "silver", isDone: false, missions: [{ id: "spend", label: "Credits Spent", target: 100000, current: 0 }] },
            { id: "level_50", name: "Big Fish Small Pond", rank: "gold", isDone: false, missions: [{ id: "lvl", label: "Level Progress", target: 50, current: 0 }] },
            { id: "ranger", name: "Golden Ridge Ranger", rank: "gold", isDone: false, missions: [{ id: "rep_gr", label: "Reputation Score (GR)", target: 1000, current: 0 }] },
            { id: "buckaroo", name: "Buckaroo", rank: "gold", isDone: false, missions: [{ id: "warden_gr", label: "Warden Missions (GR)", target: 15, current: 0 }] },
            { id: "taylor", name: "Taylor Made", rank: "gold", isDone: false, missions: [{ id: "shop_miss", label: "Shopkeeper Missions", target: 30, current: 0 }] },
            { id: "hook_sink", name: "Hook, Line and Sinker", rank: "silver", isDone: false, missions: [{ id: "tackles", label: "Unique Fishing Tackles", target: 4, current: 0 }] },
            { id: "norway_coll", name: "Norway Jose", rank: "silver", isDone: false, missions: [{ id: "nor_coll", label: "Collectibles (Norway)", target: 59, current: 0 }] },
            { id: "aguas_fish", name: "Live by the Rod, Diez by the Rod!", rank: "bronze", isDone: false, missions: [{ id: "aguas_sp", label: "Unique Species (Aguas)", target: 10, current: 0 }] },

            { id: "tourist", name: "More Than a Tourist", rank: "bronze", isDone: false, missions: [] },
            { id: "ready", name: "Ready to Rod and Roll", rank: "bronze", isDone: false, missions: [] },
            { id: "reel", name: "Fish Just Got Reel", rank: "bronze", isDone: false, missions: [] },
            { id: "sea", name: "More Fish in the Sea", rank: "bronze", isDone: false, missions: [] },
            { id: "hookin", name: "Hey Good Hookin", rank: "bronze", isDone: false, missions: [] },
            { id: "scaling", name: "Scaling Up", rank: "silver", isDone: false, missions: [] },
            { id: "bronze3", name: "Can You Smell What the Rod Is Hooking", rank: "bronze", isDone: false, missions: [] },
            { id: "boat1", name: "Iâ€™m on a Boat!", rank: "bronze", isDone: false, missions: [] },
            { id: "water3", name: "Fish Out of Water", rank: "bronze", isDone: false, missions: [] },
            { id: "gold1m", name: "Going for Gold", rank: "bronze", isDone: false, missions: [] },
            { id: "goldcatch", name: "Goldfish?", rank: "bronze", isDone: false, missions: [] },
            { id: "night", name: "Things That Go Splash in the Night", rank: "bronze", isDone: false, missions: [] },
            { id: "school", name: "Schoolâ€™s Out for Summer", rank: "bronze", isDone: false, missions: [] },
            { id: "diamond", name: "Diamond in the Rough", rank: "gold", isDone: false, missions: [] },
            { id: "lvl10", name: "License to Gill", rank: "bronze", isDone: false, missions: [] },
            { id: "catch100", name: "Iâ€™m Hooked!", rank: "silver", isDone: false, missions: [] }
        ];

        function initTracker() {
            // Update Card and Header based on currentUser
            document.getElementById('psn-card-slot').innerHTML = `
                <a href="https://psnprofiles.com/${currentUser}" target="_blank">
                    <img src="https://card.psnprofiles.com/1/${currentUser}.png" border="0" alt="PSN Trophy Card" class="psn-card-img">
                </a>
            `;

            const activeList = document.getElementById('trophy-list-active');
            const doneList = document.getElementById('trophy-list-done');
            activeList.innerHTML = ""; doneList.innerHTML = "";

            const completedCount = trophyList.filter(t => t.isDone && t.id !== 'platinum').length;
            const platTrophy = trophyList.find(t => t.id === 'platinum');
            if (platTrophy) {
                platTrophy.missions[0].current = completedCount;
                platTrophy.isDone = completedCount >= 50;
            }

            trophyList.forEach(t => {
                const card = document.createElement('div');
                card.className = `trophy-card ${t.isDone ? 'done' : ''}`;
                
                let missionHtml = "";
                t.missions.forEach(m => {
                    const isMComplete = m.current >= m.target;
                    const hideControls = t.isDone || t.id === 'platinum';
                    
                    missionHtml += `
                        <div class="mission-row">
                            <span class="mission-text">${m.label} <small>(${m.target})</small></span>
                            <div class="mission-controls">
                                ${hideControls ? '' : `<button class="btn-ctrl" onclick="updateMission('${m.id}', -1, ${m.target})">-</button>`}
                                <span id="val-${m.id}" class="count-display">${Number.isInteger(m.current) ? m.current : m.current.toFixed(2)}</span>
                                ${hideControls ? '' : `<button class="btn-ctrl" onclick="updateMission('${m.id}', 1, ${m.target})">+</button>`}
                                <span id="status-${m.id}" class="status-indicator ${isMComplete ? 'status-complete' : 'status-working'}">
                                    ${isMComplete ? '+' : '_'}
                                </span>
                            </div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="trophy-summary" onclick="toggleDetails('${t.id}')">
                        <div class="trophy-info">
                            <span class="trophy-rank rank-${t.rank}">${t.rank}</span>
                            <span class="trophy-name">${t.name}</span>
                        </div>
                        <span id="arrow-${t.id}">${t.isDone ? 'âœ“' : 'â–¼'}</span>
                    </div>
                    ${missionHtml ? `<div id="details-${t.id}" class="mission-details">${missionHtml}</div>` : ''}
                `;
                
                if (t.isDone) doneList.appendChild(card);
                else activeList.appendChild(card);
            });

            const totalDone = trophyList.filter(t => t.isDone && t.id !== 'platinum').length;
            const percentage = Math.round((totalDone / 50) * 100);
            document.getElementById('stats-summary').innerText = `User: ${currentUser} | 51 Trophies | ${totalDone}/50 Completed (${percentage}%)`;
        }

        async function syncWithPSN() {
            const btn = document.getElementById('sync-btn');
            btn.innerText = "ðŸ”„ Syncing...";
            btn.classList.add('syncing');
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://psnprofiles.com/trophies/23508-call-of-the-wild-the-angler/${currentUser}`)}`);
                const data = await response.json();
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const rows = doc.querySelectorAll('tr');
                let foundTrophies = [];
                rows.forEach(row => {
                    const titleEl = row.querySelector('.title');
                    const earnedEl = row.querySelector('.completed-date');
                    if (titleEl && earnedEl) foundTrophies.push(titleEl.innerText.trim().toLowerCase());
                });
                trophyList.forEach(t => { if (foundTrophies.includes(t.name.toLowerCase())) t.isDone = true; });
                initTracker();
                btn.innerText = "âœ… Synced!";
            } catch (error) {
                btn.innerText = "âŒ Sync Failed";
            } finally {
                setTimeout(() => {
                    btn.innerText = "ðŸ”„ Sync PSN Status";
                    btn.classList.remove('syncing');
                }, 3000);
            }
        }

        function toggleDetails(id) {
            const el = document.getElementById(`details-${id}`);
            if (!el) return;
            el.classList.toggle('active');
            document.getElementById(`arrow-${id}`).innerText = el.classList.contains('active') ? 'â–²' : 'â–¼';
        }

        function updateMission(mId, change, target) {
            trophyList.forEach(t => {
                t.missions.forEach(m => {
                    if (m.id === mId) {
                        m.current += change;
                        if (m.current < 0) m.current = 0;
                        
                        const isCollectible = ['notes_gr', 'coins_gr', 'dino_bones', 'bf_tracks', 'weather_st', 'gps_st', 'oxeye', 'water_hy', 'orange_hk', 'yellow_tf', 'engel_sp', 'douglas_fr', 'white_pine', 'petrified'].includes(mId);
                        if (isCollectible) {
                            const totalColl = trophyList.find(tr => tr.id === 'flounder').missions.find(mi => mi.id === 'collect_gr');
                            totalColl.current += change;
                        }
                        if (['towers', 'cabins', 'trailheads', 'waterbodies'].includes(mId)) {
                            const poiMission = trophyList.find(tr => tr.id === 'travel').missions.find(mi => mi.id === 'pois');
                            poiMission.current += change;
                        }
                    }
                });
            });
            initTracker();
        }

        window.onload = initTracker;
    </script>
</div>
