<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        #wp-custom-wrapper { 
            background: linear-gradient(180deg, #020617 0%, #1e3a8a 50%, #172554 100%) !important; 
            min-height: 100vh; 
            position: relative !important; 
            overflow: hidden !important; 
            width: 100% !important;
        }
        .container-90 { width: 90% !important; margin: 0 auto !important; }
        .ripple {
            position: absolute; width: 2px; height: 2px;
            background: rgba(147, 197, 253, 0.4); border-radius: 50%;
            transform: scale(0); animation: ripple-effect 0.8s ease-out;
            pointer-events: none; z-index: 1;
        }
        @keyframes ripple-effect { to { transform: scale(200); opacity: 0; } }
    </style>
</head>
<body>
    <div id="wp-custom-wrapper" onmousedown="createRipple(event)">
        <div class="container-90 py-10 relative z-10">
            <header class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-br from-purple-400 via-indigo-500 to-purple-600 tracking-tighter mb-4 uppercase italic">SQUAD TRACKING HUB</h1>
                <a href="https://www.amazon.com/s?k=fishing&tag=Werewolf3788-20" target="_blank" class="px-6 py-3 bg-orange-900/20 border border-orange-500/30 rounded-2xl text-[10px] font-black tracking-widest text-orange-400 uppercase shadow-xl">Shop Fishing Gear</a>
            </header>
            <div id="grid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC55Cb3JcK9NiDkdSHpAS3UuTEG82aze7k",
            authDomain: "angler-squad-tracker.firebaseapp.com",
            projectId: "angler-squad-tracker",
            storageBucket: "angler-squad-tracker.firebasestorage.app",
            messagingSenderId: "325679067980",
            appId: "1:325679067980:web:57edbad70fe12b988355e9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const players = [
            { id: 'terrdog420', name: 'terrdog420', aliases: 'DarkWing Dog, Darkterr', twitch: 'terrdog420', img: 'https://static-cdn.jtvnw.net/jtv_user_pictures/9dad426e-04cb-4fc0-a917-25982b3800ce-profile_image-70x70.png' },
            { id: 'Werewolf3788', name: 'Werewolf3788', aliases: 'Lead Developer', twitch: 'werewolf3788', img: 'https://static-cdn.jtvnw.net/jtv_user_pictures/1a4efdb4-023e-4802-b07c-82c09a45c4c8-profile_image-70x70.png' },
            { id: 'Raymystyro', name: 'Raymystyro', aliases: 'lonewolf, speedray, OneLIVIDMAN', twitch: 'raymystyro', img: 'https://static-cdn.jtvnw.net/jtv_user_pictures/032a0367-589f-4763-94de-4fc679a0b2df-profile_image-70x70.png' }
        ];

        const tiers = ['Legendary', 'Diamond', 'Gold', 'Silver', 'Bronze'];
        const tierColors = { Legendary: 'text-purple-500', Diamond: 'text-cyan-400', Gold: 'text-yellow-400', Silver: 'text-slate-400', Bronze: 'text-orange-700' };

        // IMPROVED: Uses FieldValue.increment to prevent sync issues
        async function updateCount(playerId, tier, delta) {
            const docRef = db.collection('catches').doc(playerId);
            await docRef.set({
                [tier]: firebase.firestore.FieldValue.increment(delta)
            }, { merge: true });
        }

        async function updateTwitch() {
            players.forEach(async (p) => {
                try {
                    const res = await fetch(`https://decapi.me/twitch/game/${p.twitch}`);
                    const game = await res.text();
                    const el = document.getElementById(`tw-${p.id}`);
                    const isOff = game.toLowerCase().includes('offline') || game.includes('not found');
                    el.innerText = isOff ? 'Offline' : `Playing: ${game}`;
                    el.className = isOff ? 'text-[10px] text-gray-500 italic' : 'text-[10px] text-purple-400 font-bold italic';
                } catch (e) {}
            });
        }

        function init() {
            document.getElementById('grid').innerHTML = players.map(p => `
                <div class="bg-slate-900/80 rounded-3xl p-6 border border-slate-800 shadow-2xl backdrop-blur-md relative z-10">
                    <div class="flex items-center gap-4 mb-6">
                        <img src="${p.img}" class="w-16 h-16 rounded-full border-2 border-purple-600 object-cover" />
                        <div>
                            <h2 class="text-xl font-black text-white uppercase tracking-tighter">${p.name}</h2>
                            <p class="text-[9px] text-slate-400 uppercase tracking-widest">${p.aliases}</p>
                            <div id="tw-${p.id}" class="mt-0.5 text-[10px]">...</div>
                        </div>
                    </div>
                    <div class="space-y-2.5">
                        ${tiers.map(t => `
                            <div class="flex items-center justify-between bg-black/40 p-3 rounded-2xl border border-white/5">
                                <span class="font-black text-[10px] ${tierColors[t]} uppercase tracking-widest">${t}</span>
                                <div class="flex items-center gap-4">
                                    <button onclick="updateCount('${p.id}', '${t}', -1)" class="w-9 h-9 bg-slate-800 hover:bg-red-600/40 text-white rounded-xl active:scale-90">-</button>
                                    <span id="count-${p.id}-${t}" class="text-2xl font-mono font-black text-white w-[1.5ch] text-center">0</span>
                                    <button onclick="updateCount('${p.id}', '${t}', 1)" class="w-9 h-9 bg-slate-800 hover:bg-green-600/40 text-white rounded-xl active:scale-90">+</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            auth.signInAnonymously().then(() => {
                players.forEach(p => {
                    db.collection('catches').doc(p.id).onSnapshot(s => {
                        if (s.exists) {
                            const data = s.data();
                            tiers.forEach(t => {
                                document.getElementById(`count-${p.id}-${t}`).innerText = data[t] || 0;
                            });
                        }
                    });
                });
            });
        }

        function createRipple(e) {
            const wrapper = document.getElementById('wp-custom-wrapper');
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            const x = (e.touches ? e.touches[0].clientX : e.clientX);
            const y = (e.touches ? e.touches[0].clientY : e.clientY);
            const rect = wrapper.getBoundingClientRect();
            ripple.style.left = `${x - rect.left}px`;
            ripple.style.top = `${y - rect.top}px`;
            wrapper.appendChild(ripple);
            setTimeout(() => ripple.remove(), 800);
        }

        window.onload = () => { init(); updateTwitch(); setInterval(updateTwitch, 60000); };
    </script>
</body>
</html>
