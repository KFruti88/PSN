<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        @import url(https://fonts.googleapis.com/css?family=Roboto:700,900);
        * { box-sizing: border-box; }
        html, body { 
            height: 100%; width: 90%; margin: 0 auto; 
            padding: 0; overflow: hidden; background: transparent; 
            font-family: 'Roboto', sans-serif; 
        }

        :root { --accent: #a020f0; }

        /* PERSISTENT TICKER */
        #chat-ticker-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: rgba(0, 0, 0, 0.7); border-bottom: 4px solid var(--accent);
            display: flex; align-items: center; overflow: hidden; z-index: 1000;
        }

        #ticker-wrapper {
            display: flex; white-space: nowrap; padding-left: 100%; 
            animation: ticker-scroll 30s linear infinite; /* Adjusted speed for readability */
        }

        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .ticker-item {
            display: inline-flex; align-items: center; padding: 0 60px;
            color: white; font-weight: 700; font-size: 22px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* BRANDING & HUD */
        #game-name-display { font-size: 28px; font-weight: 900; color: white; text-transform: uppercase; }
        .main-logo { height: 115px; width: 115px; filter: drop-shadow(0 0 15px var(--accent)); }
        
        #game-stats-hud { position: absolute; top: 60px; left: 0; display: flex; gap: 15px; opacity: 0; transition: 0.5s; }
        #game-stats-hud.active { opacity: 1; }
        .stat-pill { background: rgba(0,0,0,0.7); border-left: 4px solid var(--accent); padding: 5px 15px; border-radius: 4px; color: white; display: flex; flex-direction: column; align-items: center; }
    </style>
</head>
<body>

<div id="chat-ticker-container">
    <div id="ticker-wrapper" class="ticker-active">
        <div class="ticker-item">üê∫ THE PACK IS READY... WAITING FOR CHAT...</div>
    </div>
</div>

<div id="game-stats-hud"></div>

<div class="brand-footer" style="position: absolute; bottom: 30px; right: 40px; display: flex; align-items: center; gap: 20px;">
    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
        <div id="game-name-display">OFFLINE</div>
        <div id="shoutout-display" style="background: rgba(0,0,0,0.6); border-left: 4px solid var(--accent); padding: 10px 15px; color: white; font-weight: 700;">Support the Pack! Scan the QR! üõí</div>
    </div>
    <img src="https://github.com/KFruti88/images/blob/main/Transparent%20Dark%20Terror.png?raw=true" class="main-logo">
</div>

<script>
    const config = {
        user: "terrdog420",
        tickerLimit: 8, // Max messages to show in the loop
        firebase: { apiKey: "AIzaSyC55Cb3JcK9NiDkdSHpAS3UuTEG82aze7k", projectId: "angler-squad-tracker" },
        themes: {
            "angler": { color: "#3b82f6", icon: "üé£", stats: ['Legendary', 'Diamond', 'Gold'] },
            "hunter": { color: "#228B22", icon: "üå≤", stats: ['Great One', 'Diamond', 'Piebald'] },
            "default": { color: "#a020f0", icon: "üêæ", stats: [] }
        }
    };

    // Firebase Init
    firebase.initializeApp({ apiKey: config.firebase.apiKey, authDomain: `${config.firebase.projectId}.firebaseapp.com`, projectId: config.firebase.projectId });
    const db = firebase.firestore();
    firebase.auth().signInAnonymously();

    // CHAT PERSISTENCE LOGIC
    function handleTicker(user, message, color) {
        const wrapper = document.getElementById('ticker-wrapper');
        
        // Remove the default welcome message if it's there
        if (wrapper.innerText.includes("THE PACK IS READY")) wrapper.innerHTML = "";

        const item = document.createElement('div');
        item.className = "ticker-item";
        item.innerHTML = `<span style="font-weight:900; color:${color || 'var(--accent)'}">üê∫ ${user}:</span> <span style="margin-left:10px">${message}</span>`;
        
        wrapper.appendChild(item);

        // Keep the loop at the limit
        if (wrapper.children.length > config.tickerLimit) {
            wrapper.removeChild(wrapper.children[0]);
        }
        
        // Save to local storage so it stays after refresh/offline
        localStorage.setItem('tj_ticker_backup', wrapper.innerHTML);
    }

    // Load backup messages on startup
    window.onload = () => {
        const backup = localStorage.getItem('tj_ticker_backup');
        if (backup) document.getElementById('ticker-wrapper').innerHTML = backup;
        updateOverlay();
    };

    window.addEventListener('onEventReceived', function (obj) {
        if (obj.detail.listener === "message-receive") {
            const d = obj.detail.event.data;
            handleTicker(d.displayName, d.text, d.color);
        }
    });

    async function updateOverlay() {
        try {
            const res = await fetch(`https://decapi.me/twitch/game/${config.user}?v=${Date.now()}`);
            const game = (await res.text()).toLowerCase();
            document.getElementById('game-name-display').innerText = game.includes('not found') ? "OFFLINE" : game.toUpperCase();
            
            let active = config.themes.default;
            for(let key in config.themes) { if(game.includes(key)) { active = config.themes[key]; break; } }
            
            document.documentElement.style.setProperty('--accent', active.color);
            
            // Stats HUD logic remains the same
            const hud = document.getElementById('game-stats-hud');
            if (active.stats.length > 0) {
                hud.innerHTML = active.stats.map(s => `<div class="stat-pill"><span class="s-label">${s}</span><span id="stat-${s.replace(/\s+/g, '')}" class="s-val">0</span></div>`).join('');
                hud.classList.add('active');
                db.collection('catches').doc(config.user).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        active.stats.forEach(s => {
                            const el = document.getElementById(`stat-${s.replace(/\s+/g, '')}`);
                            if(el) el.innerText = data[s] || 0;
                        });
                    }
                });
            } else { hud.classList.remove('active'); }
        } catch (e) {}
    }

    setInterval(updateOverlay, 60000);
</script>
</body>
</html>
